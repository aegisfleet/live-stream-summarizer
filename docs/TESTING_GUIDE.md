# Local Testing Environment Setup Guide

This document outlines the steps required to set up a local testing environment for verifying frontend changes using Cypress.

## Prerequisites

- Node.js and npm
- `jq` (a command-line JSON processor)

## Setup Steps

### 1. Install Project Dependencies

Install the necessary Node.js packages defined in `package.json`.

```bash
npm install
```

### 2. Generate Mock Data for Testing

The application requires a `src/data/summaries.json` file to run. In a production environment, this file is generated by a script that requires API keys. For local testing, you can generate a mock version of this file from the existing `data/archives.json`.

Run the following command in your terminal to create the mock `summaries.json` file:

```bash
jq 'map(. + {"overview": {"summary": "This is a placeholder summary.","mood": "Normal"},"highlights": [{"title": "Start","description": "The stream begins.","timestamp": "00:10","type": "Talk"},{"title": "Middle","description": "Getting exciting.","timestamp": "15:00","type": "Game"},{"title": "End","description": "The stream ends.","timestamp": "30:00","type": "Talk"}],"tags": ["Chatting", "Game"],"overview_en": {"summary": "This is a placeholder summary.","mood": "Normal"},"highlights_en": [{"title": "Start","description": "The stream begins.","timestamp": "00:10","type": "Talk"},{"title": "Middle","description": "Getting exciting.","timestamp": "15:00","type": "Game"},{"title": "End","description": "The stream ends.","timestamp": "30:00","type": "Talk"}],"tags_en": ["Chatting", "Game"],"lastUpdated": "2025-08-15T12:00:00.000Z"})' data/archives.json > src/data/summaries.json
```

*Note: If you don't have `jq` installed, you can install it using a package manager like `sudo apt-get install jq` (on Debian/Ubuntu) or `brew install jq` (on macOS).*

### 3. Install Cypress

Install the Cypress testing framework as a dev dependency.

```bash
npm install cypress --save-dev
```

### 4. Configure Cypress

Create a `cypress.config.js` file in the root of the project with the following content:

```javascript
const { defineConfig } = require('cypress');

module.exports = defineConfig({
  e2e: {
    setupNodeEvents(on, config) {
      // implement node event listeners here
    },
    baseUrl: 'http://localhost:3000',
    supportFile: false
  },
});
```

### 5. Install Japanese Fonts (for Screenshot Verification)

To ensure that Japanese characters render correctly in screenshots on failure, it's recommended to install a Japanese font package.

```bash
# For Debian/Ubuntu-based systems
sudo apt-get update
sudo apt-get install -y fonts-takao-pgothic fonts-ipaexfont-gothic
```

### 6. Start the Application Server

Run the local development server to serve the website. It's best to run this in a separate terminal window.

```bash
npm start
```

The server will run on `http://localhost:3000`.

## Running a Test Script

Once the environment is set up and the server is running, you can execute the Cypress tests.

### Example Test Script

Create a file at `cypress/e2e/verification.cy.js` with the following content:

```javascript
describe('Frontend Verification', () => {
  it('should allow navigation to a detail page and back to home', () => {
    // a. Navigate to the main page
    cy.visit('/');

    // Wait for the main content to be loaded and find the first video
    cy.get('#archive-grid .archive-card', { timeout: 30000 }).should('have.length.gt', 0);

    // b. Click on the first video link to go to a detail page
    cy.get('#archive-grid .archive-card .clickable-thumbnail').first().click();

    // c. On the detail page, wait for it to load and scroll the player into view
    cy.get('#youtube-player', { timeout: 30000 }).scrollIntoView().should('be.visible');

    // d. Locate the "みどころ" (highlights) list and click the first three items
    cy.get('#highlights-list .highlight-item').should('have.length.gt', 0);
    cy.get('#highlights-list .highlight-item').then($items => {
        const itemsToClick = Math.min(3, $items.length);
        for (let i = 0; i < itemsToClick; i++) {
            cy.wrap($items[i]).click();
            cy.wait(500); // A short delay to allow JS to execute
        }
    });

    // e. Click the "ホームに戻る" (Back to Home) button
    cy.get('#back-to-home').should('be.visible').click();

    // f. Verify that the current URL is the home page URL
    cy.url().should('eq', 'http://localhost:3000/');
  });
});
```

### Executing the Test

Run the Cypress tests from your terminal. Cypress will automatically find and run the `verification.cy.js` file.

```bash
npx cypress run
```

You should see the test results in your terminal output.
